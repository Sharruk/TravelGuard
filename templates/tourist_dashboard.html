{% extends "base.html" %}

{% block title %}Tourist Dashboard - SafeTourism{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Mobile Navigation Header -->
    <header class="bg-primary text-primary-foreground p-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i data-lucide="shield" class="w-6 h-6"></i>
                <div>
                    <h1 class="font-bold">SafeTourism</h1>
                    <p class="text-xs opacity-90" data-testid="text-location">
                        {{ tourist.currentLocation or 'Goa, India' }}
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="text-right">
                    <p class="text-xs opacity-90">Safety Score</p>
                    <p class="font-bold text-lg" data-testid="text-safety-score">
                        {{ tourist.safetyScore or '87' }}
                    </p>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-ghost p-2 hover:bg-blue-600" data-testid="button-logout">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Quick Actions Bar -->
    <div class="bg-card border-b p-4">
        <div class="flex justify-between items-center gap-4">
            <!-- Emergency Panic Button -->
            <button class="btn btn-destructive pulse-red" id="panicButton" data-testid="button-panic">
                <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                Emergency
            </button>
            
            <!-- Location Sharing Toggle -->
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium">Location Sharing</label>
                <label class="switch">
                    <input type="checkbox" id="locationSharing" checked data-testid="switch-location-sharing">
                    <span class="switch-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="dashboard" data-testid="tab-dashboard">
            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
            Dashboard
        </button>
        <button class="tab-btn" data-tab="map" data-testid="tab-map">
            <i data-lucide="map" class="w-4 h-4 mr-1"></i>
            Map
        </button>
        <button class="tab-btn" data-tab="alerts" data-testid="tab-alerts">
            <i data-lucide="history" class="w-4 h-4 mr-1"></i>
            Alerts
        </button>
        <button class="tab-btn" data-tab="profile" data-testid="tab-profile">
            <i data-lucide="user" class="w-4 h-4 mr-1"></i>
            Profile
        </button>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active p-4 space-y-6" data-testid="content-dashboard">
        <!-- Safety Status Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Safety Status</h2>
                    <div class="w-3 h-3 bg-success rounded-full"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-success" data-testid="text-safety-score-card">
                            {{ tourist.safetyScore or '87' }}
                        </p>
                        <p class="text-sm text-muted-foreground">Safety Score</p>
                    </div>
                    <div class="text-center">
                        <span class="badge {{ utils.getStatusColor(tourist.status or 'safe') }}" data-testid="badge-zone-status">
                            {{ (tourist.status or 'safe').title() }}
                        </span>
                        <p class="text-sm text-muted-foreground mt-1">Current Zone</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Location Card -->
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-3">Current Location</h3>
                <div class="flex items-center space-x-3">
                    <i data-lucide="map-pin" class="w-5 h-5 text-primary"></i>
                    <div>
                        <p class="font-medium" data-testid="text-current-location">
                            {{ tourist.currentLocation or 'Calangute Beach, Goa' }}
                        </p>
                        <p class="text-sm text-muted-foreground">Last updated: 2 minutes ago</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-3">Recent Alerts</h3>
                <div class="space-y-3">
                    {% if alerts %}
                        {% for alert in alerts[:3] %}
                        <div class="flex items-start space-x-3 p-3 rounded-lg {{ utils.getSeverityColor(alert.severity) }}" 
                             data-testid="alert-{{ alert.id }}">
                            <i data-lucide="alert-triangle" class="w-5 h-5 mt-1"></i>
                            <div>
                                <p class="font-medium">{{ alert.type.title() }} Alert</p>
                                <p class="text-sm text-muted-foreground">{{ alert.description }}</p>
                                <p class="text-xs text-muted-foreground">
                                    {{ utils.formatDateTime(alert.createdAt) if alert.createdAt else 'Unknown' }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="flex items-start space-x-3 p-3 bg-muted rounded-lg">
                        <i data-lucide="info" class="w-5 h-5 text-primary mt-1"></i>
                        <div>
                            <p class="font-medium">No recent alerts</p>
                            <p class="text-sm text-muted-foreground">All systems are operating normally</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-3">Emergency Contacts</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span>Tourist Helpline</span>
                        <a href="tel:1363" class="btn btn-outline btn-sm" data-testid="link-tourist-helpline">
                            <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                            1363
                        </a>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Police Emergency</span>
                        <a href="tel:100" class="btn btn-outline btn-sm" data-testid="link-police-emergency">
                            <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                            100
                        </a>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Medical Emergency</span>
                        <a href="tel:108" class="btn btn-outline btn-sm" data-testid="link-medical-emergency">
                            <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                            108
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Tab -->
    <div id="map" class="tab-content p-4 space-y-4" data-testid="content-map">
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-3">Live Location Map</h3>
                <div class="h-96 map-container">
                    <div id="touristMap" class="h-full w-full"></div>
                </div>
            </div>
        </div>
        
        <!-- Map Legend -->
        <div class="card">
            <div class="card-content">
                <h4 class="font-medium mb-3">Map Legend</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-primary rounded-full"></div>
                        <span>Your Location</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-success rounded-full"></div>
                        <span>Safe Zone</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-warning rounded-full"></div>
                        <span>Caution Zone</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-destructive rounded-full"></div>
                        <span>High Risk Zone</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts History Tab -->
    <div id="alerts" class="tab-content p-4 space-y-6" data-testid="content-alerts">
        <div class="card">
            <div class="card-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">Alert History</h3>
                    <span class="badge badge-outline">{{ alerts|length }} total</span>
                </div>
                
                <div class="space-y-3">
                    {% if alerts %}
                        {% for alert in alerts %}
                        <div class="flex items-start space-x-3 p-4 rounded-lg border {{ 'bg-destructive/5 border-destructive/20' if alert.severity == 'critical' else 'bg-muted/50 border-muted' }}"
                             data-testid="alert-history-{{ alert.id }}">
                            <i data-lucide="alert-triangle" class="w-5 h-5 mt-1 {{ 'text-destructive' if alert.severity == 'critical' else 'text-warning' }}"></i>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium">{{ alert.type.title() }} Alert</p>
                                        <p class="text-sm text-muted-foreground">{{ alert.description }}</p>
                                        <p class="text-sm text-muted-foreground">
                                            Location: {{ alert.location or "Unknown" }}
                                        </p>
                                    </div>
                                    <span class="badge {{ 'bg-success/10 text-success' if alert.status == 'resolved' else 'bg-destructive/10 text-destructive' }}">
                                        {{ alert.status or 'active' }}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center mt-3 pt-3 border-t">
                                    <p class="text-xs text-muted-foreground">
                                        {{ utils.formatDateTime(alert.createdAt) if alert.createdAt else "Unknown" }}
                                    </p>
                                    <p class="text-xs font-medium text-primary">
                                        Priority: {{ alert.severity }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-12 text-muted-foreground">
                        <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p class="font-medium">No alerts in history</p>
                        <p class="text-sm">You haven't triggered any emergency alerts</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Alert Statistics -->
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-4">Alert Statistics</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-primary">
                            {{ alerts|selectattr('status', 'equalto', 'resolved')|list|length }}
                        </p>
                        <p class="text-sm text-muted-foreground">Resolved</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-warning">
                            {{ alerts|selectattr('status', 'equalto', 'active')|list|length }}
                        </p>
                        <p class="text-sm text-muted-foreground">Active</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content p-4 space-y-6" data-testid="content-profile">
        <!-- Digital Tourist ID -->
        <div class="card">
            <div class="card-content">
                <h3 class="font-semibold mb-4">Digital Tourist ID</h3>
                <div class="bg-gradient-primary text-primary-foreground p-4 rounded-lg">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm opacity-90">Tourist ID</p>
                            <p class="font-mono text-lg" data-testid="text-tourist-id">
                                {{ tourist.touristId or "TID-2024-001523" }}
                            </p>
                        </div>
                        <div class="text-2xl">🏷️</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="opacity-90">Name</p>
                            <p class="font-medium" data-testid="text-user-name">{{ user.name }}</p>
                        </div>
                        <div>
                            <p class="opacity-90">Nationality</p>
                            <p class="font-medium" data-testid="text-nationality">{{ user.nationality or "Indian" }}</p>
                        </div>
                        <div>
                            <p class="opacity-90">Valid Until</p>
                            <p class="font-medium" data-testid="text-valid-until">
                                {{ utils.formatDate(tourist.validUntil) if tourist.validUntil else "Dec 30, 2024" }}
                            </p>
                        </div>
                        <div>
                            <p class="opacity-90">Status</p>
                            <p class="font-medium text-green-200">Active</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Emergency Contacts -->
        <div class="card">
            <div class="card-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">Personal Emergency Contacts</h3>
                    <button class="btn btn-outline btn-sm" data-testid="button-add-contact">
                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                        Add
                    </button>
                </div>
                <div class="space-y-3">
                    {% if tourist.emergencyContacts %}
                        {% for contact in tourist.emergencyContacts %}
                        <div class="flex items-center space-x-3 p-3 bg-muted rounded-lg">
                            <div class="w-2 h-2 bg-primary rounded-full"></div>
                            <div class="flex-1">
                                <p class="font-medium" data-testid="contact-name-{{ loop.index0 }}">{{ contact.name }}</p>
                                <p class="text-sm text-muted-foreground" data-testid="contact-phone-{{ loop.index0 }}">
                                    {{ contact.phone }} - {{ contact.relation }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-8 text-muted-foreground">
                        <p>No personal contacts added yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Trip Itinerary -->
        <div class="card">
            <div class="card-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">Trip Itinerary</h3>
                    <button class="btn btn-outline btn-sm" data-testid="button-add-itinerary">
                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                        Add
                    </button>
                </div>
                <div class="space-y-3">
                    {% if tourist.itinerary %}
                        {% for item in tourist.itinerary %}
                        <div class="flex items-center space-x-3 p-3 bg-muted rounded-lg">
                            <div class="w-2 h-2 bg-primary rounded-full"></div>
                            <div class="flex-1">
                                <p class="font-medium" data-testid="itinerary-place-{{ loop.index0 }}">{{ item.place }}</p>
                                <p class="text-sm text-muted-foreground" data-testid="itinerary-time-{{ loop.index0 }}">
                                    {{ item.date }}, {{ item.time }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-8 text-muted-foreground">
                        <p>No itinerary items added yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass data from Flask to JavaScript
    window.userData = {{ user.to_dict()|tojson|safe if user else '{}' }};
    window.touristData = {{ tourist.to_dict()|tojson|safe if tourist else '{}' }};
    window.alertsData = {{ alerts|map(attribute='to_dict')|list|tojson|safe if alerts else '[]' }};
    
    // Store in localStorage for other scripts
    if (typeof storage !== 'undefined') {
        storage.set('user', window.userData);
        storage.set('tourist', window.touristData);
        storage.set('alerts', window.alertsData);
    }
</script>
<script src="{{ url_for('static', filename='js/tourist.js') }}"></script>
{% endblock %}